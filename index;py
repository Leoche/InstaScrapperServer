import instaloader
import json
import http.server
from functools import cached_property
from http.cookies import SimpleCookie
from http.server import BaseHTTPRequestHandler
from urllib.parse import parse_qsl, urlparse, parse_qs



class WebRequestHandler(BaseHTTPRequestHandler):
   def do_GET(self):
        username = imsi = parse_qs(urlparse(self.path).query).get('username', 'instagram')
        print(username[0])
        L = instaloader.Instaloader()
        #L.load_session_from_file("defaultusernameld", "./session-defaultusernameld")
        print("connected")
        profile = instaloader.Profile.from_username(L.context, username[0])
        print("profile")
        json_post_list = []
        for post in profile.get_posts():
            print("post")
            json_post_list.append(instaloader.get_json_structure(post).get("node"))
            if len(json_post_list) > 8:
                break
        print("res")
        self.send_response(200)
        self.send_header("Content-Type", "application/json")
        self.end_headers()
        self.wfile.write(json.dumps(json_post_list).encode("utf-8"))

PORT = 8888
server_address = ("", PORT)

server = http.server.HTTPServer
handler = http.server.CGIHTTPRequestHandler
print("Serveur actif sur le port :", PORT)

httpd = server(server_address, WebRequestHandler)
httpd.serve_forever()